---
title: Query attribution
---

A guideline for making the ClickHouse queries attribute correctly.

## Current state

We don't fully understand why our ClickHouse get sometimes overloaded.
We extensively use query's `SETTING`: `log_comment` to put JSON with bunch
of metadata inside it. 

### A bit more background 

We process thousands queries per second, historically it used to be mostly the traffic from
our application us.posthog.com / eu.posthog.com and using only one `default` ClickHouse user.
Recently, it has been a mix of different query issuers (Temporal, Celery, and services cut
out from Django), with most of the queries still using `default` user.

We've managed to separate `batch_export`, `app` and `api` traffic to use separate ClickHouse
users and tune the settings to not fully starve any of those use cases of capacity.

Most ClickHouse queries made as a result of HTTP request to Django app contains the proper

## Where we want to be

We want to know:
 * why was a query started,
 * what/who initiated the query,
 * how much resources it consumed.

This will allow us to better manage the ClickHouse load

Each query send to ClickHouse must have the following tags:

    * org_id => organization id
    * team_id => team id
    * user_id => query run initiated by a user
    * access_method => `personal_api_key` (or `app`?)
    * product => PostHog product name
    
    * route_id => route_id in `api`
    * workload => online / offline
    * dashboard_id => if part of dashboard
    * insight_id => if query is run to show insight
    * kind => it used to have
    * id => it used to have a id of a workload (e.g. celery job name, function calling it)
    
    * name => you can name your query
    * http_request_id => HTTP request that initiated a query
    * http_correlation_id => correlation id from HTTP request
