import Snippet from "../../integrate/snippet.mdx"

---
title: Setting up Caddy as a reverse proxy
sidebar: Docs
showTitle: true
---

import RegionWarning from "../_snippets/region-warning.mdx"
import ProxyWarning from "../_snippets/proxy-usage-warning.mdx"

<ProxyWarning />

<RegionWarning />

Caddy makes setting up a [reverse proxy](https://caddyserver.com/docs/quick-starts/reverse-proxy) with TLS simple. For these examples:

1. Sub out `YOUR_TRACKING_DOMAIN` for the domain you use for proxying to PostHog. We'd suggest something like `e.yourdomain.com`. 
2. Make sure your DNS records point to the server where Caddy is running. 
3. Make sure ports 80 and 443 are open and directed toward Caddy.

## Basic setup

First, [install Caddy](https://caddyserver.com/docs/install).

Next, create a `Caddyfile` that listens for incoming requests and proxies them to PostHog:

```
${YOUR_TRACKING_DOMAIN} {
  handle /static {
    reverse_proxy https://us-assets.i.posthog.com:443 {
      header_up Host us-assets.i.posthog.com
      header_down -Access-Control-Allow-Origin
    }
  }
  handle {
    reverse_proxy https://us.i.posthog.com:443 {
      header_up Host us.i.posthog.com
      header_down -Access-Control-Allow-Origin
    }
  }
}
```

Run `caddy start` from the same folder as your `Caddyfile`. Once running, you can use your tracking domain as a reverse proxy to PostHog like this:

<Snippet />

## Using a subpath

If your reverse proxy is running on the same domain as another app, you can set up a `handle_path` matcher and rewrite the path to remove it for the PostHog request. This is useful for testing the reverse proxy locally combined with the Caddy `file_server`.

To showcase this, create a folder, and then a `Caddyfile` in it like this:

```
:2015 {
  handle_path /phproxy/static* {
    rewrite * /static/{path}
    reverse_proxy https://us-assets.i.posthog.com:443 {
      header_up Host us-assets.i.posthog.com
      header_down -Access-Control-Allow-Origin
    }
  }

  handle_path /phproxy* {
    rewrite * {path}
    reverse_proxy https://us.i.posthog.com:443 {
      header_up Host us.i.posthog.com
      header_down -Access-Control-Allow-Origin
    }
  }

  file_server browse
}

```

In the same folder, create a `home.html` file with some content and the PostHog snippet.

<Snippet />

When you go to `http://localhost:2015/home.html`, events are sent to PostHog via the reverse proxy.

## Running Caddy with Docker

On the server where you run Docker, create a `Caddyfile` in `etc/caddy` like:

```
${YOUR_TRACKING_DOMAIN} {
  header {
    Access-Control-Allow-Origin https://${YOUR_TRACKING_DOMAIN}
  }

  handle /static {
    reverse_proxy https://us-assets.i.posthog.com:443 {
      header_up Host us-assets.i.posthog.com
      header_down -Access-Control-Allow-Origin
    }
  }
  handle {
    reverse_proxy https://us.i.posthog.com:443 {
      header_up Host us.i.posthog.com
      header_down -Access-Control-Allow-Origin
    }
  }
}
```

> If `YOUR_TRACKING_DOMAIN` points to the same domain as production then the above works for requests originating from that domain. If you want to test your proxy from other domains, such as `localhost`, you'll need to tweak the `Access-Control-Allow-Origin` header and/or `YOUR_TRACKING_DOMAIN` accordingly.

With Docker installed and set up, run the following command to start Caddy: 

```bash
docker run -p 80:80 -p 443:443 \
  -v $PWD/Caddyfile:/etc/caddy/Caddyfile \
  -v caddy_data:/data \
  caddy
```

You can now use your tracking domain as a reverse proxy to PostHog. See the [Docker Caddy overview for more details](https://hub.docker.com/_/caddy), especially important is the "⚠️ A note about persisted data" which explains why it is important to use a Docker volume for the `/data` folder.